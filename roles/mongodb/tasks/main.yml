---
# tasks file for mongodb

- name: Include assert.yml
  ansible.builtin.import_tasks: assert.yml
  run_once: yes
  delegate_to: localhost

# https://pgp.mongodb.com/server-6.0.asc
# /etc/apt/sources.list.d/mongodb-org-6.0.list
# echo "deb [ arch=amd64,arm64 signed-by=/usr/share/keyrings/mongodb-server-6.0.gpg ] https://repo.mongodb.org/apt/ubuntu jammy/mongodb-org/6.0 multiverse" | sudo tee /etc/apt/sources.list.d/mongodb-org-6.0.list

- name: Prepare distribtions that use "apt"
  when:
    - ansible_pkg_mgr == "apt"
  block:
    - name: Download server-6.0.asc
      ansible.builtin.get_url:
        url: "https://pgp.mongodb.com/server-6.0.asc"
        dest: /usr/share/keyrings/mongodb-server-6.0.asc
        validate_certs: no

    - name: Install mongodb repository (deb)
      ansible.builtin.apt_repository:
        repo: "deb [ arch=amd64,arm64 signed-by=/usr/share/keyrings/mongodb-server-6.0.asc ] https://repo.mongodb.org/apt/ubuntu {{ ansible_distribution_release }}/mongodb-org/6.0 multiverse"
        update_cache: yes
        validate_certs: no
        filename: mongodb-org-6.0.list

- name: Install mongodb repository (rpm)
  ansible.builtin.yum_repository:
    name: mongodb-org-6.0
    description: MongoDB Repository
    baseurl: https://repo.mongodb.org/yum/redhat/$releasever/mongodb-org/6.0/x86_64/
    gpgcheck: yes
    enabled: yes
    gpgkey: https://www.mongodb.org/static/pgp/server-6.0.asc
  when:
    - ansible_pkg_mgr in [ "dnf', "yum" ]

- name: Install mongodb-org
  ansible.builtin.package:
    name: mongodb-org

- name: Start mongodb
  ansible.builtin.service:
    name: mongod
    state: started
    enabled: yes
